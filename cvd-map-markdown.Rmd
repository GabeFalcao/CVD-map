---
title: "Death Rate from Heart Disease and Stroke in the USA - CDC data"
author: "Gabriel Falcao Alencar"
date: "January, 2018"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Heart disease is the leading cause of death in the USA, accounting for approximately 1 in every 4 deaths (@ref). **I will write more about introduction and include some figures in the next few days**.

## Prerequisites

To perform these maps, you will need to have several extra packages. I'm not going into how to install them, but a quick google search should tell you how to. The main libraries that we will need are:

1. [tidyverse](https://www.tidyverse.org/): this is a package created by Hadley Wickham. This "umbrella" package was designed to make data science analysis and visualition faster and easier. The main packages that we will use in this analysis are:
    + [dplyr](http://dplyr.tidyverse.org/): grammar of data manipulation, i.e. how to import, select, filter, and arrange your data for analysis;
    + [ggplot2](http://ggplot2.tidyverse.org/): system for declaratively creating graphics, i.e. you provide the data, tell it how to map, and it takes care of details;
    + [stringr](http://stringr.tidyverse.org/): provides a set of functions designed to make working with strings as easy as possible.
2. [maps](https://cran.r-project.org/web/packages/maps/README.html): package for displaying maps;
3. [mapdata](https://www.rdocumentation.org/packages/mapdata/versions/2.2-6): supplements the `maps` package, providing some larger and/or higher-resolution databases.
4. [ggmap](https://github.com/dkahle/ggmap): package to retrieve [raster map tiles](https://en.wikipedia.org/wiki/Tiled_web_map) (map displayed by joining dozens of individually requested image files over the internet) from popular online mapping service like Google Maps, and others.

## Load the libraries
```{r loading-packages}
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(dplyr)
library(stringr)
```

## Plotting the maps

Although the `maps` package is able to plot, we will use `ggplot2` to actually plot. For that, we will need to do some transformations in the data since `ggplot2` operates on data frames.

```{r plot-map}
usa <- map_data("usa")
dim(usa)
head(usa)
tail(usa)
# Just as an exercise will plot the USA map to define one parameter
ggplot() + geom_polygon(data=usa, aes(x=long, y=lat, group=group)) +
  coord_fixed(1.3)
```

That turned out pretty nice. The `coord_fixed()` function is very important when drawing maps. It "forces" a specific ration between the x and y axis. In our example, I asked for each *y* unit to be 1.3*x* unit. Why this is important? Because if we decide to change the size of file that we are saving, it knows the ratios and it will change accordingly, instead of potentially altering the ratios that we will use.

## Plot the county map

Now that we have a few things defined, lets plot the map with the counties just to see how it looks.

```{r county-map}
counties <- map_data("county")
dim(counties)
head(counties)
tail(counties)
# Just as an exercise will plot the USA map to define one parameter
ggplot() + geom_polygon(data=counties, aes(x=long, y=lat, fill=region, group=group), color="white") +
  coord_fixed(1.3) +
  guides(fill=FALSE)
```

Now, we have the basic shape that we will use to create our maps.

## Getting data about counties

Data was obtained from the [CDC](https://www.cdc.gov/). For this first analysis, I downloaded the data for **Deaths - Total Cardiovascular Disease** for both genders, 35+ year old individuals, from 2005 to 2015 (two year increment, 2005-2007, 2007-2009, etc). The files also have risk factors associated with CVD, such as **Obesity**, **Diabete**, and **Exercise**.

```{r loading-data}
#r stands for raw right now
r.total.05.07 <- as.data.frame(read.csv("data/2005-2007cdc-report-heart-disease-and-risk-factors.csv", header=TRUE))
r.total.07.09 <- as.data.frame(read.csv("data/2007-2009-cdc-report-heart-disease-and-risk-factors.csv", header=TRUE))
r.total.09.11 <- as.data.frame(read.csv("data/2009-2011-cdc-report-heart-disease-and-risk-factors.csv", header=TRUE))
r.total.11.13 <- as.data.frame(read.csv("data/2011-2013-cdc-report-heart-disease-and-risk-factors.csv", header=TRUE))
r.total.13.15 <- as.data.frame(read.csv("data/2013-2015-cdc-report-heart-disease-and-risk-factors.csv"))
#Check to see how the Counties are label in datasets so we can start working on them
head(counties)
head(r.total.05.07)
```

So, there are several things that we need to change. First, we need to change column names from `display_name` to `subregion`. Second, we need to remove `, (state)` from the *county* name. Third, we need to make the *county* name to be all lower case.

I will start with the `05-07` dataset first, to do trial and error. After that, I will repeat for the other years. 

```{r}
# Gonna do the 05-07 first to see how it goes. After that do the rest
r.total.05.07$subregion <- str_extract(r.total.05.07$display_name, 
                                     '[a-zA-Z]+') %>%
                         tolower()
total.05.07 <- select(r.total.05.07, subregion, 
                      Value,dm_prev_adj, 
                      ob_prev_adj,ltpia_prev_adj) %>% 
               rename(deathavg=Value,
                      diabetes=dm_prev_adj,obesity=ob_prev_adj,
                      exercise=ltpia_prev_adj) %>%
               as.data.frame(stringAsFactors=FALSE)
head(total.05.07)
head(counties)
```

That looks promising. We now have the numbers that we want, all we need is to join the tables together.

```{r join-county05-07}
#we can also remove the raw 05-07 dataset to "clear" our environment as well
rm(r.total.05.07)
counties0507 <- inner_join(counties, total.05.07, by="subregion")
head(counties0507)
```

Ok, now we are finally ready to plot the mortality rates

```{r test-plot}
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

counties_base <- ggplot(data = counties, mapping = 
                          aes(x = long, y = lat, group = group)) + 
                        coord_fixed(1.3) + 
                        geom_polygon(color = "black", fill = "gray")
counties_base

testing0507 <- counties_base + 
      geom_polygon(data = counties0507, aes(fill = deathavg), color="white")+
      geom_polygon(color = "black", fill = NA) +
      theme_bw() +
      ditch_the_axes
testing0507
```



